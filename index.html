<html>
  <head>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  </head>
  <body>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
      const user = new URLSearchParams(window.location.search).get("user");
      var socket = io({ query: { user: user, position: "25 3 0" } });

      AFRAME.registerComponent("rotation-reader", {
        tick: function () {
          const rotation = this.el.object3D.rotation;
          const position = this.el.object3D.position;
          var quaternion = new THREE.Quaternion();
          this.el.object3D.getWorldQuaternion(quaternion);
          socket.emit("move", { position, user: user, rotation, quaternion });
        },
      });

      socket.on("connect", () => {
        console.log("conected");
      });

      socket.on("guests", function (msg) {
        msg.forEach((element) => {
          if (element.user !== user) {
            var el = document.createElement("a-entity");
            var sceneEl = document.querySelector("a-scene");

            var entityElToRemoveBody = sceneEl.querySelector(
              `#${msg.user}_body`
            );

            if (!entityElToRemoveBody) {
              //create body
              var body = document.createElement("a-box");
              body.setAttribute("color", `${element.color}`);
              body.setAttribute("position", `${element.position}`);
              body.setAttribute("depth", "1");
              body.setAttribute("height", "6");
              body.setAttribute("width", "0.5");
              body.setAttribute("id", `${element.user}_body`);

              //create head
              var head = document.createElement("a-box");
              head.setAttribute("color", `white`);
              head.setAttribute(
                "position",
                `${element.position.split(" ")[0]} 6 ${
                  element.position.split(" ")[2]
                }`
              );
              head.setAttribute("depth", "1");
              head.setAttribute("height", "2");
              head.setAttribute("width", "1");
              head.setAttribute("id", `${element.user}_head`);

              //create name
              var nameElement = document.createElement("a-entity");
              nameElement.setAttribute("text", `value: ${element.user};`);
              nameElement.setAttribute(
                "position",
                `${element.position.split(" ")[0]} 7 ${
                  element.position.split(" ")[2]
                }`
              );
              nameElement.setAttribute("id", `${element.user}_name`);

              //find already spawned items
              var sceneElNew = document.querySelector("a-scene");
              var bodyFounded = sceneEl.querySelector(`#${element.user}_body`);
              if (!bodyFounded) {
                sceneEl.appendChild(body);
                sceneEl.appendChild(head);
                sceneEl.appendChild(nameElement);
              }
            }
          }
        });
      });

      socket.on("move", function (msg) {
        if (msg.user !== user) {
          var sceneEl = document.querySelector("a-scene");

          var body = sceneEl.querySelector(`#${msg.user}_body`);
          if (body) {
            body.setAttribute(
              "position",
              `${msg.position.x + 25} ${msg.position.y} ${msg.position.z}`
            );
          } else {
            console.error("cant find user:", msg.user);
          }

          var head = sceneEl.querySelector(`#${msg.user}_head`);
          if (head) {
            //head.object3D.applyQuaternion(msg.quaternion);

            head.setAttribute(
              "position",
              `${msg.position.x + 25} ${msg.position.y + 3.5} ${msg.position.z}`
            );
          } else {
            console.error("cant find user:", msg.user);
          }

          var name = sceneEl.querySelector(`#${msg.user}_name`);
          if (name) {
            name.setAttribute(
              "position",
              `${msg.position.x + 16} ${msg.position.y + 6} ${msg.position.z}`
            );

            name.setAttribute(
              "rotation",
              `180 1 180`
            );

            name.setAttribute(
              "scale",
              `20 20 20`
            );
          } else {
            console.error("cant find user:", msg.user);
          }
        }
      });
    </script>
    <a-scene background="color: #FF5733">
      <a-assets>
        <img id="plane" src="city.jpg" /><img id="sky" src="paris.jpg" />
      </a-assets>
      <a-entity id="rig" position="25 3 0">
        <a-camera id="camera" rotation-reader></a-camera>
      </a-entity>
      <a-plane
        position="0 0 0"
        rotation="-90 0 0"
        width="400"
        height="400"
        src="#plane"
      ></a-plane>
      <a-sky src="#sky"></a-sky>
    </a-scene>
  </body>
</html>
