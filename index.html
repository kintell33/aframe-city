<html>
  <head>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  </head>
  <body>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
      const user = new URLSearchParams(window.location.search).get("user");
      var socket = io({ query: { user: user, position: "25 3 0" } });

      socket.on("connect", () => {
        document.addEventListener("keydown", function (e) {
          if (e.key === "w") move();
          if (e.key === "a") move();
          if (e.key === "s") move();
          if (e.key === "d") move();
        });
      });

      socket.on("guests", function (msg) {
        msg.forEach((element) => {
          if (element.user !== user) {
            var el = document.createElement("a-entity");
            var sceneEl = document.querySelector("a-scene");
            var entityElToRemove = sceneEl.querySelector(`#${msg.user}`);
            entityElToRemove?.parentNode.removeChild(entityElToRemove);

            var entityEl = document.createElement("a-box");
            entityEl.setAttribute("color", `${element.color}`);
            entityEl.setAttribute("position", `${element.position}`);
            entityEl.setAttribute("depth", "1");
            entityEl.setAttribute("height", "6");
            entityEl.setAttribute("width", "0.5");
            entityEl.setAttribute("id", `${element.user}`);
            sceneEl.appendChild(entityEl);
            console.log(`Creo a el usuario ${element.user}`);
          }
        });
      });

      socket.on("move", function (msg) {
        console.log(user, msg.user);
        if (msg.user !== user) {
          console.log("going set position:", msg);
          var sceneEl = document.querySelector("a-scene");
          var entityEl = sceneEl.querySelector(`#${msg.user}`);
          if (entityEl) {
            entityEl.setAttribute(
              "position",
              `${msg.position.x + 25} ${msg.position.y} ${msg.position.z}`
            );
          } else {
            console.log("cant find user:", msg.user);
          }
        }
      });

      function move() {
        var sceneEl = document.querySelector("a-scene");
        var entityEl = sceneEl.querySelector("#camera");
        var position = entityEl.getAttribute("position");
        console.log("going to send position:", position);
        socket.emit("move", { position, user: user });
      }
    </script>
    <a-scene background="color: #FF5733">
      <a-assets>
        <img id="plane" src="city.jpg" /><img id="sky" src="paris.jpg" />
      </a-assets>
      <a-entity id="rig" position="25 3 0">
        <a-camera id="camera"></a-camera>
      </a-entity>
      <a-plane
        position="0 0 0"
        rotation="-90 0 0"
        width="400"
        height="400"
        src="#plane"
      ></a-plane>
      <a-sky src="#sky"></a-sky>
    </a-scene>
  </body>
</html>
